use std::{collections::HashMap, fs};

use crate::analyzer::vulnerabilities::Vulnerability;

pub fn generate_vulnerability_report(
    vulnerabilities: HashMap<Vulnerability, Vec<(String, Vec<i32>)>>,
) -> String {
    let mut vulnerability_report = String::from("");

    let vulnerability_report_sections_path: String =
        "./src/report/report_sections/vulnerabilities/".to_owned();

    //Add optimization report overview
    let overview_section =
        fs::read_to_string(vulnerability_report_sections_path.clone() + "overview.md")
            .expect("Unable to read overview.md");

    let mut high_severity_report_section = String::from("## High Risk\n");
    let mut medium_severity_report_section = String::from("## Medium Risk\n");
    //low or non critical
    let mut low_severity_report_section = String::from("## Low Risk");

    vulnerability_report.push_str((overview_section + "\n").as_str());

    for vulnerability in vulnerabilities {
        if vulnerability.1.len() > 0 {
            let vulnerability_target = vulnerability.0;

            let (report_section, vulnerability_severity) = get_vulnerability_report_section(
                vulnerability_target,
                vulnerability_report_sections_path.clone(),
            );

            let mut matches_section = String::from("### Lines\n");

            for (file_name, lines) in vulnerability.1 {
                for line in lines {
                    //- file_name:line_number\n
                    matches_section
                        .push_str(&(String::from("- ") + &file_name + ":" + &line.to_string()));
                    matches_section.push_str("\n");
                }
            }

            matches_section.push_str("\n\n");

            let completed_report_section = report_section + "\n" + matches_section.as_str();

            match vulnerability_severity {
                VulnerabilitySeverity::High => {
                    high_severity_report_section.push_str(completed_report_section.as_str());
                }
                VulnerabilitySeverity::Medium => {
                    medium_severity_report_section.push_str(completed_report_section.as_str());
                }
                VulnerabilitySeverity::Low => {
                    low_severity_report_section.push_str(completed_report_section.as_str());
                }
            }
        }
    }

    if high_severity_report_section != String::from("## High Risk\n") {
        vulnerability_report.push_str(&high_severity_report_section);
    }

    if medium_severity_report_section != String::from("## Medium Risk\n") {
        vulnerability_report.push_str(&medium_severity_report_section);
    }

    if low_severity_report_section != String::from("## Low Risk") {
        vulnerability_report.push_str(&low_severity_report_section);
    }

    vulnerability_report
}

pub enum VulnerabilitySeverity {
    High,
    Medium,
    Low,
}

pub fn get_vulnerability_report_section(
    vulnerability: Vulnerability,
    vulnerability_report_sections_path: String,
) -> (String, VulnerabilitySeverity) {
    match vulnerability {}
}
